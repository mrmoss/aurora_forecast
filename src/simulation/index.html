<!--
	#WebGl Based Aurora Simulation
	#	Created By:		Paul Gentemann, Caleb Hellickson, Ruslan Kolesnik, Ignacio Saez Lahidalga, and Mike Moss
	#	Modified On:	04/05/2014
-->

<!doctype html>

<html>
	<head>
		<meta charset="utf-8">

		<!--Three.js Source-->
		<script src="js/three.min.js"></script>
		<script src="js/TrackballControls.js"></script>
		<script src="js/OrbitControls.js"></script>

		<!--Aurora Simulation Source-->
		<script type="text/javascript">

			//Globals
			var root="";
			var kp;
			var renderer;
			var scene;
			var controls;

			var camera;
			var light;
			var universe;
			var stars;

			var width=400;
			var height=400;

			var latitude=64.8436;
			var longitude=-147.7231;

			//TESTING
			var test_point;

			//TESTING
			function show_members(obj)
			{
				var methods=[];

				for (var m in obj)
					if (typeof obj[m]=="function"&&obj.hasOwnProperty(m))
						methods.push(m);

				alert(methods.join(","));
			}

			//Get Location Callback
			function get_location(location)
			{
				latitude=location.coords.latitude;
				longitude=location.coords.longitude;
			}

			//GPS Lookat Function
			function gps_lookat(x,y)
			{
			}

			//TESTING
			function gps_update_test()
			{
				latitude=parseFloat(document.getElementById("latitude").value);
				longitude=parseFloat(document.getElementById("longitude").value);
				gps_lookat(latitude,longitude);
			}

			//Setup Function (Happens Once)
			function setup(skip_safari)
			{
				//Get Current Location
				//navigator.geolocation.getCurrentPosition(get_location);
				document.getElementById("latitude").value=latitude;
				document.getElementById("longitude").value=longitude;

				//Initialize Kp Shader Uniform
				kp=new THREE.Vector2(0.0,0.0);

				//Get Canvas Object
				var canvas=document.getElementById('canvas');
				canvas.innerHTML="";

				//Create Renderer
				renderer=new THREE.WebGLRenderer();
				renderer.setSize(width,height);
				canvas.appendChild(renderer.domElement);

				//Create Scene
				scene=new THREE.Scene();

				//Create Camera
				camera=new THREE.PerspectiveCamera(45,width/height,0.01,1000);
				camera.position.x=0;
				camera.position.y=0;
				camera.position.z=5;

				//Add Lights
				scene.add(new THREE.AmbientLight(0xaaaaaa));
				light=new THREE.DirectionalLight(0xffffff,1.5);
				light.position.set(5,3,5);
				scene.add(light);

				//Create Universe
				universe=create_universe(scene,0.5,32);

				//Create Controls
				//controls=new THREE.TrackballControls(camera,renderer.domElement);
				controls=new THREE.OrbitControls(camera,renderer.domElement);

				//TESTING
				test_point=new THREE.Mesh
				(
					new THREE.SphereGeometry(0.0125,10,10)
				);
				scene.add(test_point);

				//Start Rendering
				render();
			}

			//Render Function (Happens Every Frame Update)
			function render()
			{
				//Update Controls
				controls.update();

				//TESTING
				var test_point_radius=0.5;
				test_point.position.x=Math.sin((90-latitude)/180*Math.PI)*Math.cos(Math.PI/2+(270-longitude)/180*Math.PI)*test_point_radius;
				test_point.position.y=Math.cos((90-latitude)/180*Math.PI)*test_point_radius;
				test_point.position.z=Math.sin((90-latitude)/180*Math.PI)*Math.sin(Math.PI/2+(270-longitude)/180*Math.PI)*test_point_radius;

				//Rotate Universe
				var speed=0.0001;

				//Set North Pole Aurora
				universe.aurora_north.rotation.x=universe.planet.rotation.x-1.44;
				universe.aurora_north.rotation.y=universe.planet.rotation.y+0.07;
				universe.aurora_north.rotation.z=universe.planet.rotation.z;

				//Set South Pole Aurora
				universe.aurora_south.rotation.x=universe.planet.rotation.x+1.89;
				universe.aurora_south.rotation.y=universe.planet.rotation.y+0.06;
				universe.aurora_south.rotation.z=universe.planet.rotation.z-2.52;

				//Set North Pole Aurora View Line
				universe.view_line_north.rotation.x=universe.aurora_north.rotation.x;
				universe.view_line_north.rotation.y=universe.aurora_north.rotation.y;
				universe.view_line_north.rotation.z=universe.aurora_north.rotation.z;

				//Set South Pole Aurora View Line
				universe.view_line_south.rotation.x=universe.aurora_south.rotation.x;
				universe.view_line_south.rotation.y=universe.aurora_south.rotation.y;
				universe.view_line_south.rotation.z=universe.aurora_south.rotation.z;

				//Rotate Clouds
				universe.clouds.rotation.y+=speed;

				//Render
				requestAnimationFrame(render);
				renderer.render(scene,camera);

				//TESTING
				kp.x=parseFloat(document.getElementById("kp").value);

				var str="";

				str+="cx:\t"+camera.rotation.x+"\n";
				str+="cy:\t"+camera.rotation.y+"\n";
				str+="cz:\t"+camera.rotation.z+"\n";
				str+="lat:\t"+latitude+"\n";
				str+="lng:\t"+longitude+"\n";
				str+="kp:\t"+kp.x;

				document.getElementById("dump").value=str;
			}

			function create_universe(scene,radius,segments)
			{
				var ret={};

				ret.stars=new THREE.Mesh
				(
					new THREE.SphereGeometry(90,segments,segments),
					new THREE.MeshBasicMaterial
					({
						map:  THREE.ImageUtils.loadTexture(root+"images/galaxy_starfield.png"),
						side: THREE.BackSide
					})
				);

				scene.add(ret.stars);

				ret.planet=new THREE.Mesh
				(
					new THREE.SphereGeometry(radius,segments,segments),
					new THREE.MeshPhongMaterial
					({
						map:         THREE.ImageUtils.loadTexture(root+"images/2_no_clouds_4k.jpg"),
						bumpMap:     THREE.ImageUtils.loadTexture(root+"images/elev_bump_4k.jpg"),
						bumpScale:   0.005,
						specularMap: THREE.ImageUtils.loadTexture(root+"images/water_4k.png"),
						specular:    new THREE.Color('grey')
					})
				);

				scene.add(ret.planet);

				ret.clouds=new THREE.Mesh
				(
					new THREE.SphereGeometry(radius+0.003,segments,segments),
					new THREE.MeshPhongMaterial
					({
						map:         THREE.ImageUtils.loadTexture(root+"images/fair_clouds_4k.png"),
						transparent: true
					})
				);

				scene.add(ret.clouds);

				ret.aurora_north=new THREE.Mesh
				(
					new THREE.SphereGeometry(radius+0.006,segments,segments),
					new THREE.ShaderMaterial
					({
						transparent: true,
						uniforms:
						{
							kp:{type:"v2",value:kp},
							view_type:{type:"i",value:0}
						},
						vertexShader: document.getElementById('vertex_shader').textContent,
						fragmentShader: document.getElementById('fragment_shader').textContent
					})
				);

				scene.add(ret.aurora_north);

				ret.aurora_south=new THREE.Mesh
				(
					new THREE.SphereGeometry(radius+0.009,segments,segments),
					new THREE.ShaderMaterial
					({
						transparent: true,
						uniforms:
						{
							kp:{type:"v2",value:kp},
							view_type:{type:"i",value:0}
						},
						vertexShader: document.getElementById('vertex_shader').textContent,
						fragmentShader: document.getElementById('fragment_shader').textContent
					})
				);

				scene.add(ret.aurora_south);

				ret.view_line_north=new THREE.Mesh
				(
					new THREE.SphereGeometry(radius+0.012,segments,segments),
					new THREE.ShaderMaterial
					({
						transparent: true,
						uniforms:
						{
							kp:{type:"v2",value:kp},
							view_type:{type:"i",value:1}
						},
						vertexShader: document.getElementById('vertex_shader').textContent,
						fragmentShader: document.getElementById('fragment_shader').textContent
					})
				);

				scene.add(ret.view_line_north);

				ret.view_line_south=new THREE.Mesh
				(
					new THREE.SphereGeometry(radius+0.015,segments,segments),
					new THREE.ShaderMaterial
					({
						transparent: true,
						uniforms:
						{
							kp:{type:"v2",value:kp},
							view_type:{type:"i",value:1}
						},
						vertexShader: document.getElementById('vertex_shader').textContent,
						fragmentShader: document.getElementById('fragment_shader').textContent
					})
				);

				scene.add(ret.view_line_south);

				return ret;
			}

		</script>

		<script id="vertex_shader" type="x-shader/x-vertex">

			varying vec2 uv_coords;

			void main()
			{
				uv_coords=uv;
				gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);
			}

		</script>

		<script id="fragment_shader" type="x-shader/x-fragment">

			varying vec2 uv_coords;
			uniform vec2 kp;
			vec2 uv_coords_scaled=vec2(uv_coords.x*2.0,uv_coords.y);
			vec2 screen_center=vec2(0.5,0.5);
			uniform int view_type;

			float map(float x,float in_min,float in_max,float out_min,float out_max)
			{
				return (x-in_min)*(out_max-out_min)/(in_max-in_min)+out_min;
			}

			void draw_aurora(const float radius,const float thickness)
			{
				float radial_distance=abs(distance(uv_coords_scaled,screen_center));

				float ring_distance=abs(radial_distance-radius);

				float color=map(ring_distance,0.0,thickness/2.0,1.0,0.2);

				gl_FragColor=vec4(color-0.3,color,0.0,color);
			}

			void draw_view_line(const float radius,const float thickness)
			{
				float radial_distance=abs(distance(uv_coords_scaled,screen_center));

				float ring_distance=abs(radial_distance-radius);

				float color=map(ring_distance,0.0,thickness/2.0,1.0,0.2);

				gl_FragColor=vec4(color,0.0,0.0,color);
			}

			void main()
			{
				float ring_radius_0=0.11+kp.x*0.01;
				float ring_thickness_0=0.02+kp.x*0.03;
				float ring_radius_1=ring_radius_0+0.03+kp.x*0.005;
				float ring_thickness_1=0.01;

				if(view_type==0)
					draw_aurora(ring_radius_0,ring_thickness_0);
				else if(view_type==1)
					draw_view_line(ring_radius_1,ring_thickness_1);
				else
					discard;
			}

		</script>
	</head>

	<body onload="setup(true);">
		<div id="canvas"></div>

		<table>
			<tr>
				<td>
					debug data:<br/>
					<textarea id="dump" rows="8" cols="30"></textarea><br/>
				</td>
				<td>
					kp:<input type="range" id="kp" min="0" max="9" step="0.01" value="0"/><br/>
					lat:<input type="range" id="latitude" min="-90" max="90" step="0.01" value="0.0" onmousemove="gps_update_test();"/><br/>
					lng:<input type="range" id="longitude" min="-180" max="180" step="0.01" value="0.0" onmousemove="gps_update_test();"/>
					<!--lat:<input type="text" id="latitude" value="0.0" onchange="gps_update_test()"/><br/>
					lng:<input type="text" id="longitude" value="0.0" onchange="gps_update_test()"/>-->
				</td>
			</tr>
		</table>
	</body>
</html>